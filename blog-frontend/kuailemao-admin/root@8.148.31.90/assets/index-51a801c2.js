import{_ as re}from"./index.vue_vue_type_script_setup_true_lang-be6d18e9.js";import{d as ce,o as J,r,a1 as l,a2 as x,a3 as I,a8 as a,ag as W,ae as b,a5 as m,F as A,ak as q,af as C,A as ue,c as P,u as _,av as de,aw as pe,a6 as ve,a7 as me}from"./vue-5b89248e.js";import{t as _e,n as U,s as fe,_ as he}from"./index-2a334394.js";import{m as o,au as X,ay as ge,al as H,U as N,X as K,ag as R}from"./antd-a1128520.js";import{c as ye}from"./CompressedImage-dc0d9ea8.js";import"./chunk-YXBPAIHU-f2871816.js";import"./context-6a3352c8.js";async function D(c){return _e("/photo/back/list",c).catch(d=>o.warn(d))}async function be(c){return U("/photo/album/create",c).catch(d=>o.warn(d))}async function ke(c){return U("/photo/upload",c,{headers:{"Content-Type":"multipart/form-data"}}).catch(d=>o.warn(d))}async function we(c){return U("/photo/album/update",c).catch(d=>o.warn(d))}async function Ie(c){return fe("/photo/delete",c).catch(d=>o.warn(d))}const f=c=>(ve("data-v-143414d1"),c=c(),me(),c),Ce={class:"photo-manager"},Pe={class:"actions"},Fe={class:"left-actions"},Te=f(()=>a("i",{class:"icon"},"📁",-1)),Se=f(()=>a("span",null,"新建相册",-1)),xe=[Te,Se],ze=f(()=>a("i",{class:"icon"},"📷",-1)),$e=f(()=>a("span",null,"上传照片",-1)),Ae=[ze,$e],Ne={class:"right-actions"},Me=["disabled"],Be=f(()=>a("i",{class:"icon"},"🔄",-1)),Ge={class:"breadcrumb"},Re=f(()=>a("span",{class:"breadcrumb-separator"},"/",-1)),De=["onClick"],Ue={key:0,class:"loading-overlay"},Ve=f(()=>a("div",{class:"loading-spinner"},[a("div",{class:"icon"}),a("span",null,"加载中...")],-1)),Le=[Ve],Oe={key:1,class:"empty-state"},Ee={class:"empty-content"},je=f(()=>a("i",{class:"empty-icon"},"📁",-1)),Je=f(()=>a("p",null,"该相册还是空的哦~",-1)),We={class:"empty-actions"},qe={key:2,class:"grid-container"},Xe=["onClick"],He=f(()=>a("div",{class:"item-image album-icon"},[a("i",{class:"icon"},"📁")],-1)),Ke={class:"item-content"},Qe={class:"time"},Ye={key:0,class:"count"},Ze=["onClick"],ea=["onClick"],aa={key:1,class:"list-item"},ta={class:"item-image"},sa={class:"item-content"},na={class:"size"},la={class:"time"},oa={class:"item-actions"},ia=["onClick"],ra={class:"pagination-container"},ca={class:"upload-container"},ua=f(()=>a("div",{class:"ant-upload-text"},[a("i",{class:"icon"},"📷"),a("span",null,"点击上传照片"),a("p",{style:{"margin-top":"8px",color:"#999","font-size":"12px"}}," 支持 JPG/PNG/WebP/GIF 格式，大小不超过 4MB ")],-1)),da=ce({__name:"index",setup(c){J(()=>{Q()});const d=r([]),z=r([]);async function Q(){D({pageNum:p.value,pageSize:B.value,parentId:k.value}).then(e=>{console.log("平铺数据",e.data.page);const t=e.data.page,i=(s,h=null)=>s.filter(v=>v.parentId===h).map(v=>{if(v.type===1){const S=i(s,v.id);return{...v,children:S}}return v});d.value=i(t),console.log("构建的树形结构:",d.value)})}const k=r(null),u=r([]),F=r(!1),g=r(1),M=r(),Y={name:[{required:!0,type:"string",message:"请输入名称",trigger:"blur"}]},n=r({id:0,name:"",description:"",parentId:null,file:null}),V=r(!1),L=e=>{V.value=e},p=r(1),B=r(10),G=r(0),w=r(!1),y=async()=>{w.value=!0;try{const e=await D({pageNum:p.value,pageSize:B.value,parentId:k.value});e.code===200&&(console.log("分页数据",e.data),z.value=e.data.page,G.value=e.data.total)}catch(e){console.error("Failed to load items:",e),o.error("加载失败")}finally{w.value=!1}},Z=async e=>{p.value=e,await y()},ee=async e=>{try{if(u.value.length===0)u.value=[e];else{const t=u.value[u.value.length-1];if(e.parentId===t.id)u.value=[...u.value,e];else if(e.parentId===null)u.value=[e];else{const i=await D({pageNum:1,pageSize:1e3,parentId:null});if(i.code===200){const s=i.data.list,h=[];let v=e.id;for(;v!==null;){const S=s.find(ie=>ie.id===v);if(S)h.unshift(S),v=S.parentId;else break}u.value=h}}}}catch(t){console.error("Failed to update breadcrumb:",t),o.error("更新导航失败")}},ae=async e=>{k.value!==e.id&&(k.value===null&&(j.value=p.value),k.value=e.id,await ee(e),p.value=1,await y())},O=async e=>{if(e===-1)k.value=null,u.value=[],p.value=j.value;else{const t=u.value[e];u.value=u.value.slice(0,e+1),k.value=t.id,p.value=1}await y()},$=e=>{g.value=e,n.value={id:0,name:"",description:"",parentId:k.value,file:null},F.value=!0},te=e=>{e.type===1&&(g.value=3,n.value={id:e.id,name:e.name,description:e.description,parentId:e.parentId,file:null},F.value=!0)},E=async e=>{H.confirm({title:"确认删除",content:`确定要删除${"url"in e?"照片":"相册"} "${e.name}" 吗？`,okText:"确定",cancelText:"取消",okType:"danger",async onOk(){try{(await Ie({id:e.id,type:e.type,parentId:e.parentId})).code===200&&(o.success("删除成功"),z.value.length===1&&p.value>1&&p.value--,await y())}catch(t){console.error("Delete failed:",t),o.error("删除失败")}}})},se={beforeUpload:e=>["image/jpeg","image/png","image/webp","image/gif"].includes(e.type)?e.size/1024/1024<8?(n.value.file=e,n.value.name=e.name.split(".")[0],ne(e),!1):(o.error("图片大小不能超过 8MB"),R.LIST_IGNORE):(o.error("只支持 JPG/PNG/WebP/GIF 格式的图片"),R.LIST_IGNORE),accept:".jpg,.jpeg,.png,.webp,.gif",listType:"picture-card",maxCount:1,onPreview:()=>{L(!0)},onRemove:()=>{n.value.file=null,n.value.name="",T.value=""}},T=r(""),ne=e=>{if(e){const t=new FileReader;t.onload=i=>{var s;T.value=(s=i.target)==null?void 0:s.result},t.readAsDataURL(e)}else T.value=""},le=async()=>{var e;try{if(await((e=M.value)==null?void 0:e.validateFields()),g.value===1)(await be({name:n.value.name,description:n.value.description,parentId:n.value.parentId})).code===200&&(o.success("创建相册成功"),await y());else if(g.value===3)(await we({id:n.value.id,name:n.value.name,description:n.value.description})).code===200&&(o.success("修改相册成功"),await y());else{if(!n.value.file){o.error("请选择要上传的照片");return}try{const t=await ye(n.value.file),i=new FormData;i.append("file",t,t.name),i.append("name",n.value.name),n.value.parentId&&i.append("parentId",String(n.value.parentId)),(await ke(i)).code===200&&(o.success("上传照片成功"),await y())}catch{o.error("上传照片成功")}}F.value=!1}catch(t){console.error("Validation failed:",t)}},oe=()=>{var e;F.value=!1,(e=M.value)==null||e.resetFields()},j=r(1);return J(()=>{y()}),(e,t)=>{const i=re;return l(),x(i,null,{content:I(()=>[a("div",Ce,[a("div",Pe,[a("div",Fe,[a("button",{class:"btn primary",onClick:t[0]||(t[0]=s=>$(1))},xe),a("button",{class:"btn primary upload",onClick:t[1]||(t[1]=s=>$(2))},Ae)]),a("div",Ne,[a("button",{class:W(["btn primary refresh",{loading:w.value}]),onClick:y,disabled:w.value},[Be,a("span",null,b(w.value?"加载中...":"刷新"),1)],10,Me)])]),a("div",Ge,[a("span",{class:"breadcrumb-item",onClick:t[2]||(t[2]=s=>O(-1))},"相册管理"),(l(!0),m(A,null,q(u.value,(s,h)=>(l(),m(A,{key:s.id},[Re,a("span",{class:"breadcrumb-item",onClick:v=>O(h)},b(s.name),9,De)],64))),128))]),a("div",{class:W(["list",{loading:w.value}])},[w.value?(l(),m("div",Ue,Le)):C("",!0),z.value.length===0?(l(),m("div",Oe,[a("div",Ee,[je,Je,a("div",We,[a("button",{class:"btn primary",onClick:t[3]||(t[3]=s=>$(1))},"新建相册"),a("button",{class:"btn primary upload",onClick:t[4]||(t[4]=s=>$(2))},"上传照片")])])])):(l(),m("div",qe,[(l(!0),m(A,null,q(z.value,s=>(l(),m(A,{key:s.id},[s.type===1?(l(),m("div",{key:0,class:"list-item album-item",onClick:h=>ae(s)},[He,a("div",Ke,[a("h3",null,b(s.name),1),a("p",null,b(s.description),1),a("p",Qe,b(s.createTime),1),s.children?(l(),m("p",Ye,b(s.children.length)+" 个项目",1)):C("",!0)]),a("div",{class:"item-actions",onClick:t[5]||(t[5]=ue(()=>{},["stop"]))},[s.type===1?(l(),m("button",{key:0,class:"btn small edit",onClick:h=>te(s)},"编辑",8,Ze)):C("",!0),a("button",{class:"btn small danger",onClick:h=>E(s)},"删除",8,ea)])],8,Xe)):(l(),m("div",aa,[a("div",ta,[P(_(X),{src:s.url,alt:s.name,preview:""},null,8,["src","alt"])]),a("div",sa,[a("h3",null,b(s.name),1),a("p",na,"大小："+b(s.size)+"MB",1),a("p",la,b(s.createTime),1)]),a("div",oa,[a("button",{class:"btn small danger",onClick:h=>E(s)},"删除",8,ia)])]))],64))),128))]))],2),a("div",ra,[G.value>0?(l(),x(_(ge),{key:0,current:p.value,"onUpdate:current":t[6]||(t[6]=s=>p.value=s),pageSize:B.value,total:G.value,"show-size-changer":!1,onChange:Z},null,8,["current","pageSize","total"])):C("",!0)]),P(_(H),{visible:F.value,title:g.value===1?"新建相册":g.value===2?"上传照片":"编辑相册",onCancel:oe,onOk:le,maskClosable:!1,destroyOnClose:!0},{default:I(()=>[P(_(N),{model:n.value,ref_key:"formRef",ref:M,rules:Y},{default:I(()=>[P(_(N).Item,{label:"名称",name:"name"},{default:I(()=>[P(_(K),{value:n.value.name,"onUpdate:value":t[7]||(t[7]=s=>n.value.name=s),placeholder:"请输入名称"},null,8,["value"])]),_:1}),g.value===1||g.value===3?(l(),x(_(N).Item,{key:0,label:"描述",name:"description"},{default:I(()=>[P(_(K).TextArea,{value:n.value.description,"onUpdate:value":t[8]||(t[8]=s=>n.value.description=s),rows:3,placeholder:"请输入描述"},null,8,["value"])]),_:1})):C("",!0),g.value===2?(l(),x(_(N).Item,{key:1,label:"照片",name:"file"},{default:I(()=>[a("div",ca,[P(_(R),de(pe(se)),{default:I(()=>[ua]),_:1},16),T.value?(l(),x(_(X),{key:0,src:T.value,preview:{visible:V.value,onVisibleChange:L},style:{display:"none"}},null,8,["src","preview"])):C("",!0)])]),_:1})):C("",!0)]),_:1},8,["model"])]),_:1},8,["visible","title"])])]),_:1})}}});const ya=he(da,[["__scopeId","data-v-143414d1"]]);export{ya as default};
